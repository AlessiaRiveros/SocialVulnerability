
pdir = r'p:\11209200-020-sociale-kwetsbaarheid'
T = 10
EXTENT = "inner_circle" # or "full_extent"
METHOD = "avg" # or "tot" # for residential buildings average per building or sum of residential buildings
# HEZ_TYPE = "building"  # or "pavement"
if T == 10:
    var = '20230405155643'
elif T == 2:
    var = '20230405154342'


rule all:
    input:
        [pdir + "/data_cleaned" + "/FIAT" + "/c_final" + f"/{T}_fiat_azone.csv", pdir + "/data_cleaned" + "/Population" + "/c_final" + "/pop2016_azone.csv", pdir + "/data_cleaned" + "/Income" + "/c_final" + "/income.csv"]


rule resample_FIAT:
    input:
        fiat_shp = pdir + "/data_cleaned" + "/FIAT" + "/a_raw" + f"/t{T}_d120_20cm_groundfloorheight_{var}_results.shp",
        azone_shp = pdir + "/data_cleaned" + "/Income" + "/a_raw" + "/AZONE.shp"
    params:
        t = T
    output:
        fiat_csv = pdir + "/data_cleaned" + "/FIAT" + "/c_final" + f"/{T}_fiat_azone.csv"
    script: 
        "Equity_weighted/a_Preprocessing/resample_FIAT_to_AZONE.py"

rule resample_pop:
    input:
        uvzone_shp = pdir + "/data_cleaned" + "/Population" + "/a_raw" + "/UVZONE.shp",
        azone_shp = pdir + "/data_cleaned" + "/Income" + "/a_raw" + "/AZONE.shp"
    output:
        pop_csv = pdir + "/data_cleaned" + "/Population" + "/c_final" + "/pop2016_azone.csv",
        pop_png = pdir + "/figures_cleaned" + "/Population" + "/population2016.png"
    script:
        "Equity_weighted/a_Preprocessing/resample_UVZONE_to_AZONE.py"

rule income: # compare HEZ values with income values 
    input:
        azone_shp = pdir + "/data_cleaned" + "/Income" + "/a_raw" + "/AZONE.shp",
        inc_csv = pdir + "/data_cleaned" + "/Income" + "/a_raw" + "/Income.csv",
        hez_shp = pdir + "/data_cleaned" + "/ZEH_2021" + "/a_raw" + "/ZONAS_ECON_HOM.shp",
        districts_shp = pdir + "/data_cleaned" + "/Population" + "/a_raw" + "/INEDistritos.shp"
    # params:
    #     hez_type = HEZ_TYPE
    output:
        inc_csv = pdir + "/data_cleaned" + "/Income" + "/c_final" + "/income.csv",
        inc_hez_png = pdir + "/figures_cleaned" + "/Income" + "/inc_hez.png",
        scatterplot_png = pdir + "/figures_cleaned" + "/Income" + "/scatterplot_corr.png",
        histogram_png =  pdir + "/figures_cleaned" + "/Income" + "/histogram.png",
        districts_png =  pdir + "/figures_cleaned" + "/Income" + "/districts.png",
        scatterplot_color_png = pdir + "/figures_cleaned" + "/Income" + "/scatterplot_corr_color.png",
        heatmap_png = pdir + "/figures_cleaned" + "/Income" + "/heatmap.png",
        outliers_png = pdir + "/figures_cleaned" + "/Income" + "/outliers.png"
    script:
        "Equity_weighted/a_Preprocessing/correlation_income_HEZ.py"

rule model_EW:
    input:
        fiat_csv = pdir + "/data_cleaned" + "/FIAT" + "/c_final" + f"/{T}_fiat_azone.csv",
        inc_csv = pdir + "/data_cleaned" + "/Income" + "/c_final" + "/income.csv",
        pop_csv = pdir + "/data_cleaned" + "/Population" + "/c_final" + "/pop2016_azone.csv"
    params:
        t = T
    output:
        csv = pdir + "/data_cleaned" + "/EW" + f"/{T}_database.csv"  # combine in single csv file pop, inc, fiat, ew dam
    script:
        "Equity_weighted/b_Model/calculate_AZONE_EW.py"

rule plot_differences:
    input:
        azone_shp = pdir + "/data_cleaned" + "/Income" + "/a_raw" + "/AZONE.shp",
        # inc_csv = pdir + "/data_cleaned" + "/Income" + "/c_final" + "/income.csv", maybe not necessary anymore
        ew_csv = pdir + "/data_cleaned" + "/EW" + f"/{T}_database.csv"
    params:
        t = T,
        extent = EXTENT,
        method = METHOD
    output:
        maps_png = pdir + "/figures_cleaned" + "/EW" + f"{T}_{EXTENT}_{METHOD}_difference_map.png",
        barchart_png = pdir + "/figures_cleaned" + "/EW" + f"{T}_{EXTENT}_{METHOD}_barchart.png"
    script:
        "Equity_weighted/c_Postprocessing/visualize_maps.py"

rule policy_ranking:
    input:
        azone_shp = pdir + "/data_cleaned" + "/Income" + "/a_raw" + "/AZONE.shp",
        ew_csv = pdir + "/data_cleaned" + "/EW" + f"/{T}_database.csv"
    params:
        t = T,
        extent = EXTENT,
        method = METHOD
    output:
        heatmap_png = pdir + "/figures_cleaned" + "/Policy" + f"/{T}_{EXTENT}_{METHOD}_heatmap_ranking.png",
        map_png = pdir + "/figures_cleaned" + "/Policy" + f"/{T}_{EXTENT}_{METHOD}_map_ranking.png"
    script:
        "Equity_weighted/c_Postprocessing/heatmap_ranking.py"

rule plot_inundation:
    input:
        azone_shp = pdir + "/data_cleaned" + "/Income" + "/a_raw" + "/AZONE.shp",
        dflowfm_tif = pdir + "/data_cleaned" + "/DFlowFM" + "a/raw" + f"/DFlowFM_T{T}_D120_fou.tif"