import geopandas as gpd
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np

# input
pdir = r'p:\11210264-001-just-equitable-paths\wellbeing'
buildings_shp = pdir + "/data" + "/1-external" + "/FIAT" + "/clipped_ids.shp"
exposure_csv = pdir + "/data" + "/1-external" + "/FIAT" + "/asphalt_based" + "/exposure.csv"
azone_shp = pdir + "/data" + "/1-external" + "/income" + "/AZONE.shp"

# output
exposure_out = pdir + "/data" + "/2-interim" + "/FIAT" + "/uniform" + "/exposure.csv"

# read input data
buildings_gdf = gpd.read_file(buildings_shp)
exposure_df = pd.read_csv(exposure_csv)
azone_gdf = gpd.read_file(azone_shp)

# https://www.la-razon.com/economia/2014/08/14/la-ciudad-de-santa-cruz-lidera-con-15-mm-de-m2-la-extension-de-construcciones-habitacionales/
# promedio de 1000 dolares/m2 (2014) => 6.7 Bs = US$1 => 6700 Bs
dwelling = 6700   # Bs/m2
# incluir depreciacion y 1 - proteccion
dwelling = dwelling * 0.6 * (1 - 0.4) * 1

# get area of objects
buildings_gdf["area"] = buildings_gdf.area

buildings_gdf["maxpotdam"] = buildings_gdf["area"] * dwelling

# contents values = max structural values * 0.5 for residential buildings
buildings_gdf["content"] = buildings_gdf["maxpotdam"] * 0.5

# rename columns to match what FIAT expects
buildings_gdf = buildings_gdf.rename(columns={
    "OBJECTID": "Object ID",
    "maxpotdam": "Max Potential Damage: Structure",
    "content": "Max Potential Damage: Content"
})

# only keep columns we want to update in the exposure.csv file
buildings_gdf = buildings_gdf[["Object ID", "Max Potential Damage: Structure", "Max Potential Damage: Content"]]

# keep original column order
cols = exposure_df.columns

# drop columns we want to replace by gdf
exposure_df = exposure_df.drop(columns=["Max Potential Damage: Structure", "Max Potential Damage: Content"])

# merge exposure csv we want to update with cols we calculated in gdf
df = exposure_df.merge(buildings_gdf, on="Object ID")
df = df[cols]

# save df to csv to run FIAT again
df.to_csv(exposure_out, index=False)
