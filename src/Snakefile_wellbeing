# new p-drive
pdir = r'p:\11210264-001-just-equitable-paths\wellbeing'
T = 10
# SOURCE = "asphalt_based"  # or "income_based" or "uniform"
# FIAT = "t10_d120_20cm_groundfloorheight_20230405155643_results.shp"
# SOURCE = "income_based"
# FIAT = "t10_income_20240416153908_results.shp"
SOURCE = "uniform"
FIAT = "t10_uniform_20240418140902_results.shp"

EXTENT = "full_extent" # or "full_extent" or "inner_ring"
METHOD = "total" 


rule all:
    input:
        # [pdir + "/data_cleaned" + "/FIAT" + "/c_final" + f"/{T}_fiat_azone.csv", pdir + "/data_cleaned" + "/Population" + "/c_final" + "/pop2016_azone.csv", pdir + "/data_cleaned" + "/Income" + "/c_final" + "/income.csv"]
        # pdir + "/data_cleaned" + "/EW" + f"/{T}_database.csv"
        # pdir + "/data"+ "/3-input" + "/EW" + f"/{SOURCE}" + f"/T{T}_database.csv"
        [pdir +  "/reports" + "/figures" + "/EW" + f"/{SOURCE}" + f"/{METHOD}" + f"/T{T}_{EXTENT}_difference_map_income.png", pdir + "/reports" + "/figures" + "/policy" + f"/{SOURCE}" +  f"/{METHOD}" + f"/T{T}_{EXTENT}_heatmap_ranking_income.png"]
        # [pdir + "/figures_cleaned" + "/EW" + f"/{METHOD}" + f"/T{T}_{EXTENT}_{METHOD}_difference_map.png", pdir + "/figures_cleaned" + "/Policy" + f"/{METHOD}" + f"/T{T}_{EXTENT}_{METHOD}_heatmap_ranking.png"]

rule resample_FIAT:  # this will change for the income based max pot instead of asphalt based max pot
    input:
        fiat_shp = pdir + "/data"+ "/1-external" + "/FIAT" + f"/{SOURCE}" + f"/{FIAT}",
        azone_shp = pdir + "/data"+ "/1-external" + "/Income" + "/AZONE.shp"
    params:
        t = T
    output:
        fiat_csv = pdir + "/data" + "/2-interim" + "/FIAT" + f"/{SOURCE}" + f"/T{T}_fiat_azone.csv"
    script: 
        "1-prepare/resample_FIAT_to_AZONE.py"

rule resample_pop:
    input:
        uvzone_shp = pdir + "/data" + "/1-external" + "/population" + "/UVZONE.shp",
        azone_shp = pdir + "/data"+ "/1-external" + "/income" + "/AZONE.shp"
    output:
        pop_csv = pdir + "/data"+ "/2-interim" + "/population" + "/pop2016_azone.csv",
        pop_png = pdir + "/reports" + "/figures" + "/population" + "/population2016.png"
    script:
        "1-prepare/resample_UVZONE_to_AZONE.py"

rule income: # compare HEZ values with income values 
    input:
        azone_shp = pdir + "/data"+ "/1-external" + "/income" + "/AZONE.shp",
        inc_csv = pdir + "/data"+ "/1-external" + "/income" + "/Income.csv",
        hez_shp = pdir + "/data"+ "/1-external" + "/ZEH" + "/ZONAS_ECON_HOM.shp",
        districts_shp = pdir + "/data" + "/1-external" + "/population" + "/INEDistritos.shp"
    # params:
    #     hez_type = HEZ_TYPE
    output:
        inc_csv = pdir + "/data"+ "/2-interim" + "/income" + "/income.csv",
        inc_hez_png = pdir + "/reports" + "/figures" + "/income" + "/inc_hez.png",
        scatterplot_png = pdir + "/reports" + "/figures" + "/income" + "/scatterplot_corr.png",
        histogram_png =  pdir + "/reports" + "/figures" + "/income" + "/histogram.png",
        districts_png =  pdir + "/reports" + "/figures" + "/income" + "/districts.png",
        scatterplot_color_png = pdir + "/reports" + "/figures" + "/income" + "/scatterplot_corr_color.png",
        heatmap_png = pdir + "/reports" + "/figures" + "/income" + "/heatmap.png",
        outliers_png = pdir + "/reports" + "/figures" + "/income" + "/outliers.png"
    script:
        "1-prepare/correlation_income_HEZ.py"

rule model_EW:  # this will change for the income based max pot instead of asphalt based max pot
    input:
        fiat_csv = pdir + "/data"+ "/2-interim" + "/FIAT" + f"/{SOURCE}" + f"/T{T}_fiat_azone.csv",
        inc_csv = pdir + "/data"+ "/2-interim" + "/income" + "/income.csv",
        pop_csv = pdir + "/data"+ "/2-interim" + "/population"  + "/pop2016_azone.csv"
    params:
        t = T,
        method = METHOD
    output:
        csv = pdir + "/data"+ "/3-input" + "/EW" + f"/{SOURCE}" + f"/T{T}_database.csv"  # here comes the issue!
    script:
        "2-build/calculate_AZONE_EW.py"

rule plot_differences:  # this will change for the income based max pot instead of asphalt based max pot
    input:
        azone_shp = pdir + "/data"+ "/1-external" + "/income" + "/AZONE.shp",
        ew_csv = pdir + "/data"+ "/3-input" + "/EW" + f"/{SOURCE}" + f"/T{T}_database.csv"
    params:
        t = T,
        extent = EXTENT,
        method = METHOD
    output:
        maps_png = pdir +  "/reports" + "/figures" + "/EW" + f"/{SOURCE}" + f"/{METHOD}" + f"/T{T}_{EXTENT}_difference_map_income.png",
        barchart_png = pdir +  "/reports" + "/figures" + "/EW" + f"/{SOURCE}" + f"/{METHOD}" +  f"/T{T}_{EXTENT}_barchart_income.png"
    script:
        "5-visualize/visualize_maps.py"

rule policy_ranking:  # this will change for the income based max pot instead of asphalt based max pot
    input:
        azone_shp = pdir + "/data"+ "/1-external" + "/income" + "/AZONE.shp",
        ew_csv = pdir + "/data"+ "/3-input" + "/EW" + f"/{SOURCE}" + f"/T{T}_database.csv"
    params:
        t = T,
        extent = EXTENT,
        method = METHOD
    output:
        heatmap_png = pdir + "/reports" + "/figures" + "/policy" + f"/{SOURCE}" +  f"/{METHOD}" + f"/T{T}_{EXTENT}_heatmap_ranking_income.png",
        map_png = pdir + "/reports" + "/figures" + "/policy" + f"/{SOURCE}" + f"/{METHOD}" + f"/T{T}_{EXTENT}_map_ranking_income.png"
    script:
        "5-visualize/heatmap_ranking.py"

