import os
import geopandas as gpd
import pandas as pd
import tomli
from shapely.geometry import box
import matplotlib.pyplot as plt


pdir = r'p:\11210264-001-just-equitable-paths\wellbeing'
T = 100

csv_in = os.path.join(pdir, 'data', '4-output', f'database_T{T}.csv')
source = "asphalt_based"
# AZONE geometry
gdf = gpd.read_file(os.path.join(pdir, 'data', '1-external', 'income', 'AZONE.shp'))
png_out = os.path.join(pdir, 'reports', 'figures', 'wellbeing', source, f"T{T}.png")


df = pd.read_csv(csv_in)
df = df.dropna()
df.set_index("ID", inplace=True, drop=True)
df['Ceq'] = df['Ceq'] * -1

# sort by income from highest to lowest
df = df.sort_values(by="I_hh_year", ascending=False)

gdf = gdf.merge(df, on='ID')
# inner circle map with some of the IDs highlighted!

fig, ax = plt.subplots()
gdf.boundary.plot(ax=ax)
for i, label in enumerate(gdf.ID):
    ax.text(
        gdf.iloc[i].geometry.centroid.x,
        gdf.iloc[i].geometry.centroid.y,
        label
    )
ax.set_axis_off()
plt.tight_layout()

fig, ax = plt.subplots()
# colors = ['#DDDDDD', '#777777', '#000000']
colors = ["orange", "red", "purple"]
df[['d_kprv_hh', 'Ceq', 'total_cons_loss']].plot(ax=ax, kind="barh", stacked=False, color=colors)
ax.legend(["Housing asset losses", "Well-being losses", "Total consumption losses"])
# ax.xaxis.set_major_formatter(ticker.FuncFormatter(format_func))
ax.set_xlabel("Losses (Bs)")
plt.tight_layout()
# plt.savefig(png_out)
plt.show()