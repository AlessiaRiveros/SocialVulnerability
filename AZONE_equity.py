import os
import pandas as pd
import numpy as np

pdir = r'p:\11209200-020-sociale-kwetsbaarheid\Data'

inc = pd.read_excel(os.path.join(pdir, 'Income', 'Income.xlsx'), sheet_name="AZONE", index_col="AZONE")  # 152
pop = pd.read_csv(os.path.join(pdir, 'Income', 'AZONEwithPop16.csv'), index_col="IDazone")  # 152

T = 2
# configurations
peopleperhh = 4
# R income information
R = np.array([1500, 2500, 4500, 6500, 8500, 10500, 12500, 14500]) / peopleperhh * 12  # [months/year]
# equity weight gamma
gamma = 1.2
building_type = "residential"

tdam = pd.read_csv(os.path.join(pdir, 'FIAT', f'AZONEwithT{T}{building_type}damages.csv'), index_col="IDazone")  # 132
print(tdam)
# rename index
inc.index.names = ["IDazone"]
# pop.index.names = ["IDazone"]
# tdam.index.name = ["IDazone"]

# fraction population interviewed
inc['frpopint'] = inc['Total'] * peopleperhh / pop['POP16']

# total population
totpop = pop.sum().item()

# income per capita per year per AZONE
inc['incpercapperyear'] = (inc['R1'] * R[0] + inc['R2'] * R[1] + inc['R3'] * R[2] + inc['R4'] * R[3] + inc['R5'] * R[4] \
                          + inc['R6'] * R[5] + inc['R7'] * R[6] + inc['R8'] * R[7]) / inc['Total']

# income per capita per year in the whole area
inc['incperyear'] = inc['incpercapperyear'] * pop['POP16']
totincpercapperyear = inc['incperyear'].sum() / totpop

# equity weight
inc['EW'] = (inc['incpercapperyear'] / totincpercapperyear)**-gamma
inc['EW_TD_E'] = inc['EW'] * tdam['TD_E']
print(inc.tail(5))
inc.to_csv(os.path.join(pdir, 'FIAT', f'AZONEwithT{T}EW{building_type}damages.csv'))