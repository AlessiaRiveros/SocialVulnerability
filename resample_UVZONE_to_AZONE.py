import geopandas as gpd
import os

pdir = r'p:\11209200-020-sociale-kwetsbaarheid\Data'
uvzone = gpd.read_file(os.path.join(pdir, 'Population', 'UVZONE.shp'))
azone = gpd.read_file(os.path.join(pdir, 'Income', 'AZONE.shp'))

# drop unused columns from uvzone
uvzone = uvzone.drop(columns=['MUNICIPIO', 'DISTRITO', 'ETUV', 'AREA', 'POP12', 'POP20', 'POP25', 'POP30', 'POP35', 'EMP', 'Population'])
# rename ids
uvzone = uvzone.rename(columns={"ID": "IDuvzone"})
azone = azone.rename(columns={"ID": "IDazone"})

# get centroid before reprojection
uvzone['centroid'] = uvzone["geometry"].centroid
uvzone.set_geometry('centroid', drop=True, inplace=True)
# reproject crs
crs = 'EPSG:4326'
uvzone = uvzone.to_crs(crs)

# spatial join
gdf = gpd.sjoin(azone, uvzone, how='inner', predicate='intersects')
df = gdf.groupby('IDazone')['POP16'].sum()
df.to_csv(os.path.join(pdir, 'Income', 'AZONEwithPop16.csv'))
