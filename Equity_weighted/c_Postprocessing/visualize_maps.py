import matplotlib.pyplot as plt
import geopandas as gpd
import pandas as pd
import os
from mpl_toolkits.axes_grid1 import make_axes_locatable
from shapely.geometry import box
import seaborn as sns

pdir = r'p:\11209200-020-sociale-kwetsbaarheid'

# ----------------- configurations -----------------
T = 10
# how to aggregate max damages, total = sum, average per building = mean
method = 'total'  # "total" or "average"
building_type = "residential"
# consider the whole extent or only the inner ring
extent = 'full_extent'  # "full_extent" or "inner_ring"
# boundary for the income classes "high", "med" or "low
pd.set_option('display.max_columns', None)

# ----------------- load data -----------------

if T == 2 or T == 10:
    if method == "average":
        vmax1 = 300
        vmin2 = -50
        vmax2 = 50
        label = 'Bs/building'
    elif method == "total":
        vmax1 = 550000
        vmin2 = -200000
        vmax2 = 200000
        label = 'Bs/AZONE'
    else:
        print('please specify average or total')
else:
    print('Only damages for T=2 and T=10 have been calculated')

azone = gpd.read_file(os.path.join(pdir, 'Data', 'Income', 'AZONE.shp'))
ew = pd.read_csv(os.path.join(pdir, 'Data', 'FIAT', 'EW', f'AZONE_T{T}_{building_type}_{method}_low.csv'))
tot_dam = pd.read_csv(os.path.join(pdir, 'Data', 'FIAT', 'AZONE', f'AZONE_T{T}_{building_type}_{method}_damages.csv'))

# rename id
azone.index.names = ["IDazone"]

# merge gdf with df
azone[f'TD_T{T}'] = tot_dam['TD_E']

# extent
if extent == "inner_ring":
    ew = ew[ew['inner_ring'] == 'Yes']

azone[f'EW_T{T}'] = ew['EW_TD_E']
azone['diff_EW'] = ew['diff_TD-EW']

# mask where EW is not nan to facilitate comparison
azone = azone[azone[f'EW_T{T}'].notnull()]

# boundaries to exclude areas where FIAT results not available
xmin = -63.26
xmax = -63.05
ymin = -17.9
ymax = -17.65

bbox = box(xmin, ymin, xmax, ymax)
azone = gpd.clip(azone, mask=bbox)
print(f'There are {len(azone)} AZONES considered')

# convert to dataframe to sum rows
df = pd.DataFrame(azone[[f'TD_T{T}', f'EW_T{T}']])
df = df.sum()

# ----------------- plotting -----------------

# plot in a 1 by 3 the total (average) residential damages, the difference between the EW and the bar chart
fig, ax = plt.subplots(1, 3, figsize=(12, 4))

ax0_divider = make_axes_locatable(ax[0])
ax1_divider = make_axes_locatable(ax[1])
ax2_divider = make_axes_locatable(ax[2])

cax0 = ax0_divider.append_axes("right", size="5%", pad="1%")
cax1 = ax1_divider.append_axes("right", size="5%", pad="1%")
cax2 = ax2_divider.append_axes("right", size="5%", pad="1%")

azone.plot(column=f'TD_T{T}', ax=ax[0], cax=cax0, cmap='OrRd', vmax=vmax1, legend=True, legend_kwds={"label": label})
azone.plot(column=f'EW_T{T}', ax=ax[1], cax=cax1, cmap='OrRd', vmax=vmax1, legend=True, legend_kwds={"label": label})
azone.plot(column='diff_EW', ax=ax[2], cax=cax2, cmap='bwr_r', vmin=vmin2, vmax=vmax2, legend=True, legend_kwds={"label": "Bs"})
# sns.barplot(x=df.index, y=df.values, ax=ax[2])

ax[0].title.set_text('Residential Damages')
ax[1].title.set_text('EW Residential Damages')
ax[2].title.set_text('TD Event - EW')

ax[0].set_axis_off()
ax[1].set_axis_off()
ax[2].set_axis_off()
# ax[2].title.set_text(f'Sum of {method} Residential Damages')

fig.suptitle(f'T={T} {method}')
plt.tight_layout()
plt.savefig(os.path.join(pdir, 'Figures', 'Residential', f'T{T}', f'{T}_{building_type}_{method}_{extent}_damages.png'))

# bar chart of total
plt.figure(figsize=(3, 4))
sns.barplot(x=df.index, y=df.values)
plt.title(f'Sum of {method} Residential Damages')
plt.ylabel('Bs')
plt.tight_layout()
plt.savefig(os.path.join(pdir, 'Figures', 'Residential', f'T{T}', f'T{T}_{building_type}_{method}_{extent}_bar_chart.png'))

plt.show()