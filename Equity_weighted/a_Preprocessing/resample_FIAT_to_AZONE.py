import geopandas as gpd
import os
import tomli
from shapely.geometry import box

with open(r"p:\11209200-020-sociale-kwetsbaarheid\Data\config.toml", mode="rb") as fp:
    config = tomli.load(fp)

# pdir = r'p:\11209200-020-sociale-kwetsbaarheid'

# ----------------- configurations -----------------
# T=2 or T=10
# T = '10'
# # 'residential' or 'all
# building_type = 'residential'
# # how to aggregate max damages, total = sum, average per building = mean
# method = 'total'  # 'average' or 'total'
T = snakemake.params.t

# ----------------- load data -----------------
# if T == '10':
#     var = '20230405155643'
# elif T == '2':
#     var = '20230405154342'
# else:
#     print('Only damages for T=2 and T=10 have been calculated')
#
# fiat = gpd.read_file(os.path.join(pdir, 'Data', 'FIAT', f't{T}_d120_20cm_groundfloorheight_{var}_results.shp'))
# azone = gpd.read_file(os.path.join(pdir, 'Data', 'Income', 'AZONE.shp'))

fiat = gpd.read_file(snakemake.input.fiat_shp)
azone = gpd.read_file(snakemake.input.azone_shp)
csv_out = snakemake.output.fiat_csv

# ----------------- process data -----------------

# boundaries to exclude areas where FIAT results are not available
xmin = config['xmin']
xmax = config['xmax']
ymin = config['ymin']
ymax = config['ymax']

bbox = box(xmin, ymin, xmax, ymax)
azone = gpd.clip(azone, mask=bbox)

# keep columns of interest
fiat = fiat[['PriObjType', 'PotDamStr', 'PotDamCon', 'PotDamOth', 'TD_E', 'ID_E', 'geometry']]
fiat['centroid'] = fiat.centroid  # no warning
fiat.set_geometry('centroid', drop=True, inplace=True)

fiat = fiat[fiat['PriObjType'] == 'Residential']

# rename id
azone = azone.rename(columns={"ID": "IDazone"})

# reproject crs
crs = 'EPSG:4326'
fiat = fiat.to_crs(crs)

# spatial join
gdf = gpd.sjoin(azone, fiat, how='inner', predicate='intersects')

# fill nan values
gdf = gdf.fillna(0)

# aggregate at azone level
df = gdf.groupby(['IDazone'])[['PotDamStr', 'PotDamCon', 'PotDamOth', 'TD_E']].sum()
# count number of residential building per AZONE
count = gdf.groupby(['IDazone'])[['PotDamStr', 'PotDamCon', 'PotDamOth', 'TD_E']].count()

df['TotPotDam'] = df['PotDamStr'] + df['PotDamCon'] + df['PotDamOth']
df['RelDam'] = df['TD_E'] / df["TotPotDam"]
df['Buildings'] = count
df.to_csv(csv_out)
# df.to_csv(os.path.join(pdir, 'Data', 'FIAT', 'AZONE', f'AZONE_T{T}_{building_type}_{method}_damages.csv'))

# # inundation depth
# azone['ID_E'] = df['ID_E']
# print(azone['ID_E'])
# # ----------------- plotting -----------------
# plt.figure(figsize=(7, 5))
# sns.scatterplot(data=df, x=df.index, y='ID_E')
# plt.ylabel('Inundation Depth')
# plt.savefig(os.path.join(pdir, 'Figures', 'Exposure', f'T{T}_inundation_depth_scatterplot.png'))
#
# fig, ax = plt.subplots(1, figsize=(5, 5))
# azone.plot(column='ID_E', ax=ax, cmap='OrRd', legend=True)
# plt.savefig(os.path.join(pdir, 'Figures', 'Exposure', f'T{T}_inundation_depth_map.png'))
# plt.show()