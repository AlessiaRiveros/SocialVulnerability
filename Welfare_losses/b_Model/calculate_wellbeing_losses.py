import pandas as pd
import geopandas as gpd
import os
import matplotlib.pyplot as plt
from mpl_toolkits.axes_grid1 import make_axes_locatable
from shapely.geometry import box
from functions import eq_cons_loss

pdir = r'p:\11209200-020-sociale-kwetsbaarheid'

df = pd.read_csv(os.path.join(pdir, 'Data', 'INE', 'processed', 'EPF1516_Persona Ingreso_processed.csv'))
gdf = gpd.read_file(os.path.join(pdir, 'Data', 'Income', 'AZONE.shp'))
T = 10  # or 10

df['loss'] = df.apply(eq_cons_loss, axis=1)
print(df['loss'])

# boundaries to exclude areas where FIAT results not available
xmin = -63.26
xmax = -63.05
ymin = -17.9
ymax = -17.65

bbox = box(xmin, ymin, xmax, ymax)
gdf = gpd.clip(gdf, mask=bbox)

fig, ax = plt.subplots(1, 1, figsize=(7, 5))

ax_divider = make_axes_locatable(ax)

cax = ax_divider.append_axes("right", size="5%", pad="1%")

gdf['loss'] = df['loss']
gdf.plot(column='loss', ax=ax, cax=cax, legend=True)
ax.set_title('Cumulative welfare losses per household at AZONE level [Bs]')
plt.savefig(os.path.join(pdir, 'Figures', 'Residential', f'T{T}', 'Welfare', 'Welfare_hh.png'))
plt.show()