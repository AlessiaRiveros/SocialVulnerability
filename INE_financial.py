import pandas as pd
import os
import seaborn as sns
import matplotlib.pyplot as plt

pdir = r'p:\11209200-020-sociale-kwetsbaarheid'

pd.set_option('display.max_columns', None)

# df = pd.read_spss(os.path.join(pdir, 'Data', 'INE', 'Bases_EPF_2015-2016', 'EPF1516_GastoCorrienteAgregado.sav'))
df = pd.read_spss(os.path.join(pdir, 'Data', 'INE', 'Bases_EPF_2015-2016', 'EPF1516_Erogaciones Financieras.sav'))

"""
folio: unique hh id
area: urban or rural
dept: 07 Santa Cruz, ...
upm: unidad primaria de muestreo 
estrato: E. Bajo, E. Medio Bajo, E. Medio Alto, E. Alto
factor: relacionado con la probabilidad de seleccion que cada individuo tiene en una muestra
base: libreta o cuestionario de origen, solo hay casos C4- anual(erogaciones financieras) 
fila: numero de fila asignada segun la boleta min 1 max 18
c4_s4_01: codigo de producto/servicio (ahorro en el hogar, deposito de dinero en cuentas, caja de ahorros, ..)
c4_s4_02a: cual es el valor total al contado - valor total (en Bs) (gasto en promedio)
c4_s4_02c: numero de meses/unidad (numero de meses correspondiente al valor total)
c4_s4_02d: unidad de medida (unidad de medida declarada por el informante)
"""

# filter to area of interest dept = Santa Cruz and urban
df = df.loc[(df['area'] == 'Urbana') & (df['dept'] == '07 Santa Cruz')]
print(f'After filtering by urban area and department, there are {len(df)} rows left.')

# drop area and dept
df = df.drop(columns=['area', 'dept'])

# only one single value C4- anual(erogaciones financieras), drop this column
df['base'].unique()
df = df.drop(columns=['base'])

# only keep rows with estrato bajo? and then compute savings and then get mean?
df = df.loc[df['estrato'] == 'E. Bajo']
df['S'] = 0

# savings
mask = ((df['c4_s4_01'] == 'Ahorro en el hogar (no en instituciones financieras)') | (df['c4_s4_01'] == 'Dep√≥sito de dinero en cuentas, caja de Ahorros'))

# print(df['c4_s4_02d'].value_counts())
# Solo hay meses como unidad de medida

# yearly savings = amount * times
df['S'] = df.loc[mask, 'c4_s4_02a'] * df.loc[mask, 'c4_s4_02c']
df['S'] = df['S'].fillna(0)

print(f'Mean yearly savings for Poor hh: {df.S.mean():.2f}')
print(f'Median yearly savings for Poor hh: {df.S.median()}')

# ----------------- plotting -----------------

# visualize savings
# hue_order = ['E. Alto', 'E. Medio Alto', 'E. Medio Bajo', 'E. Bajo']

fig, ax = plt.subplots(1, figsize=(5, 5))
sns.kdeplot(data=df, x="S", ax=ax)
ax.set_xlabel('Yearly Savings [Bs]')
ax.set_xlim(left=0)

# # sns.catplot(data=df, x="c4_s4_02c", y="c4_s4_02d", kind="bar")
# sns.stripplot(data=df, x='c4_s4_02d', y='c4_s4_01', hue="c4_s4_02c")
plt.tight_layout()
plt.savefig(os.path.join(pdir, 'Figures', 'INE', 'processed', 'Hh_poor_savings.png'))
plt.show()