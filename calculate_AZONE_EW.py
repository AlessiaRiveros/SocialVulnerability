import os
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

pdir = r'p:\11209200-020-sociale-kwetsbaarheid\Data'

# ----------------- configurations -----------------
T = 10
building_type = "residential"
peopleperhh = 4
pd.set_option('display.max_columns', None)

# ----------------- load data -----------------
tdam = pd.read_csv(os.path.join(pdir, 'FIAT', f'AZONEwithT{T}{building_type}damages.csv'), index_col="IDazone")  # 132
inc = pd.read_excel(os.path.join(pdir, 'Income', 'Income.xlsx'), sheet_name="AZONE", index_col="AZONE")  # 152
pop = pd.read_csv(os.path.join(pdir, 'Income', 'AZONEwithPop16.csv'), index_col="IDazone")  # 152

# ----------------- process data -----------------
# R income information
boundary_type = 'high'
if boundary_type == 'low':
    R = np.array([1500, 2000, 4000, 6000, 8000, 10000, 12000, 14000]) / peopleperhh * 12  # [months/year]
elif boundary_type == 'high':
    R = np.array([1999, 3999, 5999, 7999, 9999, 11999, 13999, 14500]) / peopleperhh * 12  # [months/year]
elif boundary_type == 'med':
    R = np.array([1500, 3000, 5000, 7000, 9000, 11000, 13000, 14500]) / peopleperhh * 12  # [months/year]
else:
    print('please specify high, med, low')


# equity weight gamma
gamma = 1.2

# rename index
inc.index.names = ["IDazone"]
# pop.index.names = ["IDazone"]
# tdam.index.name = ["IDazone"]

# fraction population interviewed
inc['frpopint'] = inc['Total'] * peopleperhh / pop['POP16']

# add total damages event
inc['TD_E'] = tdam['TD_E']

# total population
totpop = pop.sum().item()
print(f"The total population considered is {round(totpop)}")

# income per capita per year per AZONE
inc['incpercapperyear'] = (inc['R1'] * R[0] + inc['R2'] * R[1] + inc['R3'] * R[2] + inc['R4'] * R[3] + inc['R5'] * R[4] \
                          + inc['R6'] * R[5] + inc['R7'] * R[6] + inc['R8'] * R[7]) / inc['Total']

# income per capita per year in the whole area
inc['incperyear'] = inc['incpercapperyear'] * pop['POP16']
totincpercapperyear = inc['incperyear'].sum() / totpop
print(f"The total income per capita per year is Bs {totincpercapperyear}")

# equity weight
inc['EW'] = (inc['incpercapperyear'] / totincpercapperyear)**-gamma
inc['EW_TD_E'] = inc['EW'] * inc['TD_E']

# difference between total damages minus EW damages
inc['diff_TD-EW'] = inc['TD_E'] - inc['EW_TD_E']
# inc.to_csv(os.path.join(pdir, 'FIAT', 'EW', f'AZONE_T{T}_{boundary_type}_EW_{building_type}.csv'))
