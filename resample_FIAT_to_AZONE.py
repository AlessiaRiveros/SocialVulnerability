import geopandas as gpd
import os
import pandas as pd

pdir = r'p:\11209200-020-sociale-kwetsbaarheid\Data'

T = '2'
building_type = 'residential'

if T == '10':
    var = '20230405155643'
elif T == '2':
    var = '20230405154342'

fiat = gpd.read_file(os.path.join(pdir, 'FIAT', f't{T}_d120_20cm_groundfloorheight_{var}_results.shp'))
azone = gpd.read_file(os.path.join(pdir, 'Income', 'AZONE.shp'))

# keep columns of interest
fiat = fiat[['PriObjType', 'PotDamStr', 'PotDamCon', 'PotDamOth', 'TD_E', 'geometry']]
fiat['centroid'] = fiat.centroid  # no warning
fiat.set_geometry('centroid', drop=True, inplace=True)

# rename id
azone = azone.rename(columns={"ID": "IDazone"})

# reproject crs
crs = 'EPSG:4326'
fiat = fiat.to_crs(crs)

# spatial join
gdf = gpd.sjoin(azone, fiat, how='inner', predicate='intersects')

# fill nan values
gdf = gdf.fillna(0)

# aggregate at azone level
df = gdf.groupby(['IDazone'])[['PotDamStr', 'PotDamCon', 'PotDamOth', 'TD_E']].sum()
df['TotPotDam'] = df['PotDamStr'] + df['PotDamCon'] + df['PotDamOth']
df['RelDam'] = df['TD_E'] / df["TotPotDam"]
df.to_csv(os.path.join(f'AZONEwithT{T}{building_type}damages.csv'))