import os
import pandas as pd
import geopandas as gpd
import matplotlib.pyplot as plt
from shapely.geometry import box
from mpl_toolkits.axes_grid1 import make_axes_locatable
import seaborn as sns
import numpy as np

pdir = r'p:\11209200-020-sociale-kwetsbaarheid'
pd.set_option('display.max_rows', 500)

# ----------------- load data -----------------
# population data in correct AZONE level
pop = pd.read_csv(os.path.join(pdir, 'Data', 'Income', 'AZONE_Pop16.csv'))

# computed average income per AZONE level
inc = pd.read_csv(os.path.join(pdir, 'Data', 'Income', 'AZONE_income.csv'))

# income from INE survey for Santa Cruz urban area
INE = pd.read_csv(os.path.join(pdir, 'Data', 'INE', 'processed', 'EPF1516_Persona Ingreso_processed.csv'))

# AZONE shapefile
gdf = gpd.read_file(os.path.join(pdir, 'Data', 'Income', 'AZONE.shp'))

# ----------------- process data -----------------

# boundaries to exclude areas where FIAT results not available
xmin = -63.26
xmax = -63.05
ymin = -17.9
ymax = -17.65

bbox = box(xmin, ymin, xmax, ymax)
gdf = gpd.clip(gdf, mask=bbox)

# rename index
pop = pop.rename(columns={"IDazone": "ID"})

# merge dataframes
df = pd.merge(pop, inc, on="ID")

# remove rows where Total = 0, no people were interviewed for those areas
df.dropna(subset=['Income'], inplace=True)

# rank from lowest to highest
df = df.sort_values(by='Income').reset_index(drop=True)
INE = INE.sort_values(by='ym_especie').reset_index(drop=True)

# cum sum of population from lowest income to highest income
df['cumpop16'] = df['POP16'].cumsum()
INE['cumpop'] = INE['pop'].cumsum()

# create another column with the higher end of income data
df['Income_high'] = df['Income'].shift(-1)
df.loc[df.index[-1], 'Income_high'] = 6000
INE['ym_high'] = INE['ym_especie'].shift(-1)

# for now exclude rows where ym_especie falls outside the boundary of the income data
mask = (INE['ym_high'] >= df['Income'].iloc[0]) & (INE['ym_especie'] <= df['Income'].iloc[-1])
INE = INE[mask].reset_index(drop=True)

# no panda way of doing this merge as far as I know
# add lower threshold from df income
INE['threshold'] = 0
INE['ID'] = 0
for i in range(len(df)):
    threshold = df['Income'].iloc[i].item()
    azone = df['ID'].iloc[i].item()
    INE.loc[INE['ym_especie'] >= threshold, 'threshold'] = threshold
    INE.loc[INE['ym_especie'] >= threshold, 'ID'] = azone


# remove first row
INE = INE.iloc[1:]
INE = INE[['reco_time', 'ID']].groupby('ID').mean()

# merge processed INE with gdf
gdf = gdf.merge(INE, on='ID')

# ----------------- plotting -----------------

fig, ax = plt.subplots(1, 1, figsize=(14, 8))

ax_divider = make_axes_locatable(ax)

cax = ax_divider.append_axes("right", size="5%", pad="1%")

gdf.plot(ax=ax, column='reco_time', cax=cax, legend=True, legend_kwds={"label": "reco_time [yrs]"})


# visualize inc on x and cumpop on y axis
# fig, ax = plt.subplots(1, figsize=(14, 8))
# ax = sns.barplot(df[['Income', 'cumpop16']], x='Income', y='cumpop16')
#
# ax.set_xticklabels(ax.get_xticklabels(), rotation=90)
#
# i = 0
#
# for label in ax.xaxis.get_ticklabels():
#     i = i + 1
#     if i % 2 == 0:
#         label.set_visible(False)

# visualize mapping spatially


plt.tight_layout()
plt.show()